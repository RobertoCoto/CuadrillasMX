<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper	namespace="com.fyg.cuadrillas.dao.AgendaTx">

<insert id="altaAgenda" parameterType="Agenda" useGeneratedKeys="true" keyProperty="id_agenda"  keyColumn="id_agenda">
INSERT INTO agenda(id_contrato,fecha_inicio,fecha_fin,no_trabajadores,no_horas,no_semana,fecha_alta,usuario_alta,estatus)
VALUES(#{idContrato},#{fechaInicio},#{fechaFin},#{noTrabajadores},#{noHoras},#{noSemana},now(),#{usuario},'A')

    <selectKey keyProperty="idAgenda" resultType="Integer" order="AFTER">
		SELECT LAST_INSERT_ID();
	</selectKey>
</insert>

<insert id="registraAgendaDetalles" parameterType="AgendaDetalle" useGeneratedKeys="true" keyProperty="id_agenda_detalle"  keyColumn="id_agenda_detalle">
INSERT INTO agenda_detalle(id_agenda,fecha,avance_esperado,observaciones,fecha_alta,usuario_alta,estatus)
VALUES (
#{idAgenda},#{fecha},#{avanceEsperado},#{observaciones},now(),#{usuarioAlta},'A'
)
<selectKey keyProperty="idAgendaDetalle" resultType="Integer" order="AFTER">
		SELECT LAST_INSERT_ID();
</selectKey>
</insert>

<insert id="registraAgendaActividad" parameterType="java.util.HashMap">
	INSERT INTO agenda_actividades
	(
		id_agenda_detalle,codigo_actividad,usuario_alta,fecha_alta,estatus
	)
	VALUES
	(
		#{id_agenda_detalle}, #{actividad}, #{usuario}, now(), 'A'
	)
</insert>

<insert id="registraAgendaCoordenada" parameterType="Coordenada">
INSERT INTO agenda_coordenadas
		(
			id_contrato,id_agenda_detalle,	orden,	direccion,
			latitud,	longitud,	fecha_alta,	estatus
		)
	VALUES
	<foreach collection="list" item="element" index="index" separator=",">
	 	(
			#{element.idContrato},#{element.idAgendaDetalle}, #{element.orden},	#{element.direccion},
			#{element.latitud},	#{element.longitud}, now(),	'A'
	 	)
	</foreach>
</insert>

<insert id="registraAgendaMateria" parameterType="AgendaDetalle">
INSERT INTO agenda_materiales(id_agenda_detalle,codigo_material,usuario_alta,fecha_alta,estatus)
VALUES
<foreach collection="list" item="element" index="index" separator=",">
(
#{element.idAgendaDetalle},#{element.codigoMaterial},#{usuarioAlta},now(),'A'
)
</foreach>
</insert>

<update id="bajaAgenda" parameterType="Agenda">
UPDATE agenda SET
		estatus = 'I',
		usuario_baja = #{usuario},
		usuario_ult_mod= #{usuario},
		fecha_baja = now(),
		fecha_ult_mod = now()
WHERE id_agenda = #{idAgenda}
AND estatus = 'A'
</update>

<update id="modificaAgenda" parameterType="Agenda">
UPDATE agenda SET
		id_contrato = #{idContrato},
		fecha_inicio = #{fechaInicio},
		fecha_fin = #{fechaFin},
		no_trabajadores = #{noTrabajadores},
		no_horas = #{noHoras},
		no_semana = #{noSemana},
		usuario_ult_mod= #{usuario},
		fecha_ult_mod = now()
WHERE id_agenda = #{idAgenda}
AND estatus = 'A'
</update>
<update id="modificaAgendaDetalle" parameterType="AgendaDetalle">
UPDATE agenda_detalle
		SET
		fecha = #{fecha},
		avance_esperado = #{avanceEsperado},
		observaciones = #{observaciones},
		usuario_ult_mod= #{usuario},
		fecha_ult_mod = now()
WHERE id_agenda = #{idAgenda}
AND estatus = 'A'
</update>

<delete id="eliminaActividades" parameterType="AgendaDetalle">
DELETE FROM agenda_actividades
WHERE id_agenda_detalle = #{idAgendaDetalle}
</delete>

<delete id="eliminaMateriales" parameterType="AgendaDetalle">
DELETE FROM agenda_materiales
WHERE id_agenda_detalle = #{idAgendaDetalle}
</delete>

<delete id="eliminaCoordenadas" parameterType="AgendaDetalle">
DELETE FROM agenda_coordenadas
WHERE id_agenda_detalle = #{idAgendaDetalle}
</delete>
</mapper>